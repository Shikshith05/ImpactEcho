<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ImpactEcho ‚Äî Admin Dashboard</title>
  <link rel="stylesheet" href="/static/style2.css" />
  <style>
    .tabs{
      display:flex;
      gap:16px;
      margin-bottom:32px;
      border-bottom:2px solid rgba(139,92,246,0.2);
      padding-bottom:16px;
      overflow-x:auto;
      overflow-y:hidden;
      white-space:nowrap;
      scrollbar-width:thin;
      scrollbar-color:rgba(139,92,246,0.5) rgba(255,255,255,0.05);
      position:relative;
      scroll-behavior:smooth;
      padding-right:40px;
    }
    .tabs::after{
      content:'‚Üí';
      position:absolute;
      right:0;
      top:0;
      bottom:16px;
      width:40px;
      background:linear-gradient(90deg, transparent 0%, rgba(10,14,39,0.95) 50%);
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(139,92,246,0.7);
      font-size:24px;
      font-weight:700;
      pointer-events:none;
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{opacity:0.5;}
      50%{opacity:1;}
    }
    .tabs::-webkit-scrollbar{
      height:8px;
    }
    .tabs::-webkit-scrollbar-track{
      background:rgba(255,255,255,0.05);
      border-radius:4px;
    }
    .tabs::-webkit-scrollbar-thumb{
      background:rgba(139,92,246,0.5);
      border-radius:4px;
    }
    .tabs::-webkit-scrollbar-thumb:hover{
      background:rgba(139,92,246,0.7);
    }
    .tab{
      background:rgba(255,255,255,0.05);
      border:2px solid rgba(139,92,246,0.2);
      padding:12px 24px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      color:#94a3b8;
      transition:all 0.2s ease;
      flex-shrink:0;
      white-space:nowrap;
    }
    .tab:hover{
      background:rgba(139,92,246,0.1);
      transform:translateY(-2px);
    }
    .tab.active{
      background:linear-gradient(135deg,var(--neon-pink) 0%,var(--neon-purple) 100%);
      color:white;
      border-color:transparent;
    }
    .tab-content{
      display:none;
    }
    .tab-content.active{
      display:block;
    }
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:20px;
      margin-bottom:32px;
    }
    .stat-card{
      background:rgba(10,14,39,0.6);
      border:2px solid rgba(139,92,246,0.2);
      border-radius:16px;
      padding:24px;
      text-align:center;
    }
    .stat-value{
      font-size:36px;
      font-weight:900;
      background:linear-gradient(135deg,var(--neon-pink),var(--neon-purple));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .stat-label{
      color:#94a3b8;
      font-size:14px;
      margin-top:8px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      background:rgba(10,14,39,0.6);
      border-radius:12px;
      overflow:hidden;
    }
    thead{
      background:rgba(139,92,246,0.2);
    }
    th,td{
      padding:16px;
      text-align:left;
      border-bottom:1px solid rgba(139,92,246,0.1);
    }
    th{
      font-weight:700;
      color:#ffffff;
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:1px;
    }
    td{
      color:#cbd5e1;
      font-size:14px;
    }
    tr:hover{
      background:rgba(139,92,246,0.05);
    }
    .address{
      font-family:monospace;
      font-size:12px;
      color:var(--neon-blue);
    }
    .timestamp{
      color:#94a3b8;
      font-size:12px;
    }
    .amount{
      color:var(--neon-green);
      font-weight:700;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="/static/logo.png" alt="ImpactEcho" class="logo-img" style="width:50px;height:50px;object-fit:contain;margin-right:12px;"><span class="brand-name">ImpactEcho Admin</span>
    </div>
    <nav class="nav-right">
      <span id="adminName" style="color:#cbd5e1;margin-right:16px;"></span>
      <button onclick="window.location.href='/admin-logout'" class="btn-link">Logout</button>
    </nav>
  </header>

  <main class="container">
    <section class="card" style="max-width:100%;margin:30px auto;">
      <h2 style="margin-bottom:32px;">Admin Dashboard</h2>
      
      <!-- Stats Grid -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalLogins">0</div>
          <div class="stat-label">Total Logins</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalDonations">0</div>
          <div class="stat-label">Total Donations</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalAmount">‚Çπ0</div>
          <div class="stat-label">Total Amount</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab('users')">Users</div>
        <div class="tab" onclick="switchTab('logins')">Login Logs</div>
        <div class="tab" onclick="switchTab('donations')">Donation Logs</div>
        <div class="tab" onclick="switchTab('ngo-requests')">NGO Requests</div>
        <div class="tab" onclick="switchTab('organizations')">Organizations</div>
        <div class="tab" onclick="switchTab('cause-requests')">Cause Requests</div>
        <div class="tab" onclick="switchTab('deletion-requests')">üóëÔ∏è Deletions</div>
        <div class="tab" onclick="switchTab('contracts')">üìÑ Contracts</div>
        <div class="tab" onclick="switchTab('signed-contracts')">‚úçÔ∏è Signed Contracts</div>
        <div class="tab" onclick="switchTab('verification')">ü§ñ AI Verification</div>
        <div class="tab" onclick="switchTab('causes')">Add Cause</div>
      </div>

      <!-- Users Tab -->
      <div class="tab-content active" id="users-tab">
        <h3 style="margin-bottom:20px;">Registered Users</h3>
        <div style="overflow-x:auto;">
          <table id="usersTable">
            <thead>
              <tr>
                <th>Wallet Address</th>
                <th>Joined Date</th>
                <th>Total Donations</th>
                <th>Total Amount</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr><td colspan="4" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Login Logs Tab -->
      <div class="tab-content" id="logins-tab">
        <h3 style="margin-bottom:20px;">Login Activity</h3>
        <div style="overflow-x:auto;">
          <table id="loginsTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>User Type</th>
                <th>Identifier</th>
              </tr>
            </thead>
            <tbody id="loginsBody">
              <tr><td colspan="3" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Donation Logs Tab -->
      <div class="tab-content" id="donations-tab">
        <h3 style="margin-bottom:20px;">Donation History</h3>
        <div style="overflow-x:auto;">
          <table id="donationsTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Wallet Address</th>
                <th>Cause</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="donationsBody">
              <tr><td colspan="4" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- NGO Requests Tab -->
      <div class="tab-content" id="ngo-requests-tab">
        <h3 style="margin-bottom:20px;">Pending NGO Registrations</h3>
        <div id="ngoRequestsContainer"></div>
      </div>

      <!-- Organizations Tab -->
      <div class="tab-content" id="organizations-tab">
        <h3 style="margin-bottom:20px;">Approved Organizations</h3>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Unique ID</th>
                <th>Organization Name</th>
                <th>Email</th>
                <th>Contact Person</th>
                <th>Phone</th>
                <th>Approved Date</th>
              </tr>
            </thead>
            <tbody id="orgsBody">
              <tr><td colspan="6" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Cause Requests Tab -->
      <div class="tab-content" id="cause-requests-tab">
        <h3 style="margin-bottom:20px;">NGO Cause Requests</h3>
        <div id="causeRequestsContainer"></div>
      </div>

      <!-- Deletion Requests Tab -->
      <div class="tab-content" id="deletion-requests-tab">
        <h3 style="margin-bottom:20px;">üóëÔ∏è Cause Deletion Requests</h3>
        <div id="deletionRequestsList"></div>
      </div>

      <!-- Contracts Tab -->
      <div class="tab-content" id="contracts-tab">
        <h3 style="margin-bottom:20px;">üìÑ NGO Partnership Contracts</h3>
        <div style="overflow-x:auto;">
          <table class="table">
            <thead>
              <tr>
                <th>NGO ID</th>
                <th>NGO Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="contractsTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Signed Contracts Review Tab -->
      <div class="tab-content" id="signed-contracts-tab">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
          <h3 style="margin:0;">‚úçÔ∏è Signed Contracts Awaiting Review</h3>
          <button onclick="loadSignedContracts()" class="fund-btn" style="padding:8px 16px;font-size:14px;">
            üîÑ Refresh
          </button>
        </div>
        <div id="signedContractsList"></div>
      </div>

      <!-- AI Verification Tab -->
      <div class="tab-content" id="verification-tab">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h3 style="margin:0;">ü§ñ AI Bill Verification Requests</h3>
          <button onclick="loadVerificationRequests()" class="fund-btn" style="padding:8px 16px;font-size:14px;">
            üîÑ Refresh
          </button>
        </div>
        <div id="verificationRequestsList"></div>
      </div>

      <!-- Add Cause Tab -->
      <div class="tab-content" id="causes-tab">
        <h3 style="margin-bottom:20px;">Add New Cause</h3>
        <form id="addCauseForm">
          <label>Title</label>
          <input type="text" id="title" class="input" required />

          <label>Description</label>
          <textarea id="description" class="input" required></textarea>

          <label>Goal Amount (‚Çπ)</label>
          <input type="number" id="goal" class="input" required />

          <label>Image URL</label>
          <input type="text" id="image" class="input" required />

          <button type="submit" class="fund-btn" style="margin-top:15px;">Add Cause</button>
        </form>
        <p id="message" class="muted small" style="margin-top:10px;"></p>
      </div>
    </section>
  </main>

  <script>
    let currentTab = 'users';

    function switchTab(tab) {
      currentTab = tab;
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tab + '-tab').classList.add('active');
      
      // Load data for specific tabs
      if (tab === 'deletion-requests') loadDeletionRequests();
      if (tab === 'contracts') loadContracts();
      if (tab === 'signed-contracts') loadSignedContracts();
      if (tab === 'verification') loadVerificationRequests();
    }

    async function loadData() {
      try {
        const res = await fetch('/api/admin/data');
        const data = await res.json();
        
        // Update stats
        document.getElementById('totalUsers').textContent = data.users.length;
        document.getElementById('totalLogins').textContent = data.login_logs.length;
        document.getElementById('totalDonations').textContent = data.donation_logs.length;
        const totalAmount = data.donation_logs.reduce((sum, log) => sum + log.amount, 0);
        document.getElementById('totalAmount').textContent = `‚Çπ${totalAmount.toLocaleString()}`;
        
        // Load users
        loadUsers(data.users);
        
        // Load login logs
        loadLoginLogs(data.login_logs);
        
        // Load donation logs
        loadDonationLogs(data.donation_logs);
      } catch (err) {
        console.error('Error loading data:', err);
      }
    }

    async function loadNGOData() {
      try {
        const res = await fetch('/api/admin/ngo-data');
        const data = await res.json();
        
        // Load NGO requests
        loadNGORequests(data.registrations);
        
        // Load organizations
        loadOrganizations(data.registrations.filter(r => r.status === 'approved'));
        
        // Load cause requests
        loadCauseRequests(data.cause_requests);
      } catch (err) {
        console.error('Error loading NGO data:', err);
      }
    }

    function loadNGORequests(regs) {
      const container = document.getElementById('ngoRequestsContainer');
      const pending = regs.filter(r => r.status === 'pending');
      
      if (pending.length === 0) {
        container.innerHTML = '<p style="color:#94a3b8;">No pending requests</p>';
        return;
      }
      
      container.innerHTML = pending.map(r => `
        <div style="background:rgba(10,14,39,0.6);border:2px solid rgba(139,92,246,0.2);border-radius:16px;padding:24px;margin-bottom:20px;">
          <h3 style="margin-bottom:12px;">${r.org_name}</h3>
          <p><strong>Email:</strong> ${r.email}</p>
          <p><strong>Contact Person:</strong> ${r.person_name}</p>
          <p><strong>Phone:</strong> ${r.contact}</p>
          <p><strong>Submitted:</strong> ${new Date(r.submitted_at).toLocaleString()}</p>
          ${r.files.length > 0 ? `<p><strong>Files:</strong> ${r.files.map(f => `<a href="/uploads/${f}" target="_blank" style="color:var(--neon-blue);">${f}</a>`).join(', ')}</p>` : ''}
          <button onclick="approveNGO(${r.id})" style="margin-top:12px;padding:10px 20px;background:linear-gradient(135deg,var(--neon-pink),var(--neon-purple));color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;">Approve & Assign ID</button>
        </div>
      `).join('');
    }

    async function approveNGO(id) {
      if (!confirm('Approve this NGO registration?')) return;
      try {
        const res = await fetch(`/admin-approve-ngo/${id}`, {method: 'POST'});
        const data = await res.json();
        if (data.success) {
          alert(`Approved! Unique ID assigned: ${data.unique_id}`);
          loadNGOData();
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function loadOrganizations(orgs) {
      const tbody = document.getElementById('orgsBody');
      if (orgs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">No approved organizations yet</td></tr>';
        return;
      }
      
      tbody.innerHTML = orgs.map(org => `
        <tr>
          <td class="address">${org.unique_id}</td>
          <td><strong>${org.org_name}</strong></td>
          <td>${org.email}</td>
          <td>${org.person_name}</td>
          <td>${org.contact}</td>
          <td class="timestamp">${new Date(org.approved_at).toLocaleString()}</td>
        </tr>
      `).join('');
    }

    function loadCauseRequests(requests) {
      const container = document.getElementById('causeRequestsContainer');
      const pending = requests.filter(r => r.status === 'pending');
      
      if (pending.length === 0) {
        container.innerHTML = '<p style="color:#94a3b8;">No pending cause requests</p>';
        return;
      }
      
      container.innerHTML = pending.map(r => `
        <div style="background:rgba(10,14,39,0.6);border:2px solid rgba(139,92,246,0.2);border-radius:16px;padding:24px;margin-bottom:20px;">
          <h3 style="margin-bottom:12px;">${r.title}</h3>
          <p style="color:#94a3b8;margin-bottom:12px;">${r.description}</p>
          <p><strong>NGO:</strong> ${r.ngo_name}</p>
          <p><strong>Goal:</strong> ‚Çπ${r.goal.toLocaleString()}</p>
          <p><strong>Submitted:</strong> ${new Date(r.submitted_at).toLocaleString()}</p>
          <button onclick="approveCause(${r.id})" style="margin-top:12px;padding:10px 20px;background:linear-gradient(135deg,var(--neon-pink),var(--neon-purple));color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;">Approve & Add to Dashboard</button>
        </div>
      `).join('');
    }

    async function approveCause(id) {
      if (!confirm('Approve this cause and add to main dashboard?')) return;
      try {
        const res = await fetch(`/admin-approve-cause/${id}`, {method: 'POST'});
        const data = await res.json();
        if (data.success) {
          alert('Cause approved and added to dashboard!');
          loadNGOData();
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function loadUsers(users) {
      const tbody = document.getElementById('usersBody');
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#94a3b8;">No users yet</td></tr>';
        return;
      }
      
      tbody.innerHTML = users.map(user => `
        <tr>
          <td class="address">${user.wallet_address}</td>
          <td class="timestamp">${new Date(user.joined_date).toLocaleString()}</td>
          <td>${user.total_donations}</td>
          <td class="amount">‚Çπ${user.total_amount.toLocaleString()}</td>
        </tr>
      `).join('');
    }

    function loadLoginLogs(logs) {
      const tbody = document.getElementById('loginsBody');
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#94a3b8;">No logs yet</td></tr>';
        return;
      }
      
      // Reverse to show latest first
      const reversedLogs = [...logs].reverse();
      
      tbody.innerHTML = reversedLogs.map(log => `
        <tr>
          <td class="timestamp">${new Date(log.timestamp).toLocaleString()}</td>
          <td>${log.user_type === 'admin' ? 'üîê Admin' : 'ü¶ä Donator'}</td>
          <td class="address">${log.identifier}</td>
        </tr>
      `).join('');
    }

    function loadDonationLogs(logs) {
      const tbody = document.getElementById('donationsBody');
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#94a3b8;">No donations yet</td></tr>';
        return;
      }
      
      // Reverse to show latest first
      const reversedLogs = [...logs].reverse();
      
      tbody.innerHTML = reversedLogs.map(log => `
        <tr>
          <td class="timestamp">${new Date(log.timestamp).toLocaleString()}</td>
          <td class="address">${log.wallet_address}</td>
          <td>${log.cause}</td>
          <td class="amount">‚Çπ${log.amount.toLocaleString()}</td>
        </tr>
      `).join('');
    }

    // Add Cause Form
    const form = document.getElementById('addCauseForm');
    const message = document.getElementById('message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        goal: Number(document.getElementById('goal').value),
        image: document.getElementById('image').value.trim()
      };

      try {
        const res = await fetch('/causes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.ok) {
          message.style.color = 'green';
          message.textContent = `Cause "${result.cause.title}" added successfully!`;
          form.reset();
        } else {
          message.style.color = 'red';
          message.textContent = result.error || 'Something went wrong';
        }
      } catch (err) {
        message.style.color = 'red';
        message.textContent = 'Error: ' + err.message;
      }
    });

    // ====================
    // DELETION REQUESTS
    // ====================
    async function loadDeletionRequests() {
      try {
        const res = await fetch('/api/admin/deletion-requests');
        const requests = await res.json();
        const container = document.getElementById('deletionRequestsList');
        
        if (requests.length === 0) {
          container.innerHTML = '<p class="muted">No deletion requests.</p>';
          return;
        }
        
        container.innerHTML = requests.map(req => `
          <div class="request-card" style="background:rgba(10,14,39,0.6);border:2px solid rgba(139,92,246,0.2);border-radius:16px;padding:24px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:start;">
              <div style="flex:1;">
                <h3 style="margin-bottom:12px;">Cause ID: ${req.cause_id}</h3>
                <p style="margin-bottom:8px;"><strong>NGO:</strong> ${req.ngo_name}</p>
                <p style="margin-bottom:8px;"><strong>Reason:</strong> ${req.reason}</p>
                <p style="margin-bottom:8px;"><strong>Status:</strong> <span class="status-badge status-${req.status}">${req.status}</span></p>
                <p class="muted small">Requested: ${new Date(req.timestamp).toLocaleString()}</p>
                ${req.approved_at ? `<p class="muted small" style="color:#00ff87;">Approved: ${new Date(req.approved_at).toLocaleString()}</p>` : ''}
              </div>
              ${req.status === 'pending' ? `
                <button onclick="approveDeletion(${req.id})" class="fund-btn" style="background:#ff006e;">Approve & Delete</button>
              ` : ''}
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error loading deletion requests:', err);
      }
    }

    async function approveDeletion(requestId) {
      if (!confirm('Are you sure you want to approve this deletion? This will permanently remove the cause.')) return;
      
      try {
        const res = await fetch(`/admin-approve-deletion/${requestId}`, {
          method: 'POST'
        });
        const data = await res.json();
        alert(data.message || 'Deletion approved!');
        loadDeletionRequests();
      } catch (err) {
        alert('Error approving deletion');
      }
    }

    // ====================
    // CONTRACTS
    // ====================
    async function loadContracts() {
      try {
        // Load approved NGOs for contract generation
        const ngoRes = await fetch('/api/admin/ngo-data');
        const ngoData = await ngoRes.json();
        const approvedNGOs = ngoData.registrations.filter(r => r.status === 'approved');
        
        const tbody = document.getElementById('contractsTableBody');
        if (approvedNGOs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="muted">No approved NGOs yet.</td></tr>';
          return;
        }
        
        tbody.innerHTML = approvedNGOs.map(ngo => `
          <tr>
            <td>${ngo.unique_id || 'N/A'}</td>
            <td>${ngo.org_name}</td>
            <td>
              <button onclick="generateContract(${ngo.id})" class="fund-btn" style="padding:8px 16px;">Generate Contract</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading contracts:', err);
      }
    }

    async function generateContract(ngoId) {
      if (!confirm('Generate partnership contract for this NGO?')) return;
      
      try {
        const res = await fetch(`/admin-generate-contract/${ngoId}`, {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          alert(`‚úÖ ${data.message}\n\nContract: ${data.filename}\n\nThe NGO has been notified.`);
        } else {
          alert('Error: ' + (data.error || 'Failed to generate contract'));
        }
      } catch (err) {
        alert('Error generating contract: ' + err.message);
      }
    }

    // ====================
    // AI VERIFICATION
    // ====================
    async function loadVerificationRequests() {
      try {
        console.log('üîÑ Loading verification requests...');
        const res = await fetch('/api/admin/verification-requests');
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const requests = await res.json();
        console.log('üìä Verification requests loaded:', requests.length, 'requests');
        
        const container = document.getElementById('verificationRequestsList');
        
        if (!requests || requests.length === 0) {
          container.innerHTML = `
            <div style="text-align:center;padding:40px;">
              <p class="muted">No verification requests yet.</p>
              <p class="muted small" style="margin-top:8px;">Bills submitted by NGOs will appear here.</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = requests.map(req => {
          const r = req.ai_result || {};
          
          // Safety checks for undefined values
          const verdict = r.verdict || 'UNKNOWN';
          const confidence = r.confidence || 0;
          const riskLevel = r.risk_level || 'HIGH';
          const amountRequested = r.amount_requested || req.amount_requested || 0;
          const amountExtracted = r.amount_extracted || 0;
          const amountDifference = r.amount_difference || 0;
          const analysis = r.analysis || 'Analysis not available';
          const recommendation = r.recommendation || 'Manual review required';
          const detailedBreakdown = r.detailed_breakdown || {};
          
          const borderColor = verdict === 'GENUINE' ? 'rgba(34,197,94,0.5)' : verdict === 'NEEDS_REVIEW' ? 'rgba(251,191,36,0.5)' : 'rgba(239,68,68,0.5)';
          const bgColor = verdict === 'GENUINE' ? 'rgba(34,197,94,0.1)' : verdict === 'NEEDS_REVIEW' ? 'rgba(251,191,36,0.1)' : 'rgba(239,68,68,0.1)';
          
          return `
          <div class="request-card" style="background:rgba(10,14,39,0.7);border:3px solid ${borderColor};border-radius:16px;padding:24px;margin-bottom:24px;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:20px;">
              <h3 style="margin:0;">üí∞ Payment Request #${req.id}</h3>
              <span style="background:${riskLevel === 'LOW' ? 'linear-gradient(135deg, #00ff87, #22c55e)' : riskLevel === 'MEDIUM' ? 'linear-gradient(135deg, #fbbf24, #f59e0b)' : 'linear-gradient(135deg, #ff006e, #ef4444)'};padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;">
                ${riskLevel} RISK
              </span>
            </div>
            
            <!-- Request Info -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:20px;">
              <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;">
                <p class="muted small">NGO Organization</p>
                <p style="font-weight:700;font-size:15px;">${req.ngo_name}</p>
              </div>
              <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;">
                <p class="muted small">Cause ID</p>
                <p style="font-weight:700;font-size:15px;">${req.cause_id}</p>
              </div>
              <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;">
                <p class="muted small">Amount Requested</p>
                <p style="font-weight:700;color:#00ff87;font-size:18px;">‚Çπ${amountRequested.toLocaleString()}</p>
              </div>
              <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;">
                <p class="muted small">Bills Uploaded</p>
                <p style="font-weight:700;font-size:15px;">${req.bills.length} files</p>
              </div>
            </div>
            
            <!-- AI Analysis Section -->
            <div style="background:${bgColor};border:2px solid ${borderColor};border-radius:12px;padding:20px;margin-bottom:20px;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="font-size:32px;">ü§ñ</span>
                <div style="flex:1;">
                  <h4 style="margin:0 0 4px 0;">AI Verification Analysis</h4>
                  <p class="muted small" style="margin:0;">Automated bill authenticity verification</p>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:36px;font-weight:700;color:${verdict === 'GENUINE' ? '#00ff87' : verdict === 'NEEDS_REVIEW' ? '#fbbf24' : '#ff006e'};">
                    ${confidence}/100
                  </div>
                  <p class="muted small" style="margin:0;">Confidence Score</p>
                </div>
              </div>
              
              <!-- Verdict -->
              <div style="margin-bottom:16px;">
                <p style="margin-bottom:8px;"><strong style="font-size:15px;">Final Verdict:</strong></p>
                <span style="display:inline-block;padding:10px 20px;border-radius:10px;font-weight:700;font-size:16px;background:${verdict === 'GENUINE' ? '#00ff87' : verdict === 'NEEDS_REVIEW' ? '#fbbf24' : '#ff006e'};color:#000;">
                  ${verdict === 'GENUINE' ? '‚úÖ GENUINE' : verdict === 'NEEDS_REVIEW' ? '‚ö†Ô∏è NEEDS REVIEW' : '‚ùå SUSPICIOUS'}
                </span>
              </div>
              
              <!-- Amount Verification -->
              <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;margin-bottom:12px;">
                <p style="margin-bottom:8px;"><strong>üí∞ Amount Verification:</strong></p>
                <p style="margin:4px 0;font-size:14px;">Requested: <strong style="color:#8b5cf6;">‚Çπ${amountRequested.toLocaleString()}</strong></p>
                <p style="margin:4px 0;font-size:14px;">Extracted from bills: <strong style="color:#00ff87;">‚Çπ${amountExtracted.toLocaleString()}</strong></p>
                <p style="margin:4px 0;font-size:14px;">Difference: <strong style="color:${amountDifference <= amountRequested * 0.15 ? '#00ff87' : '#ff006e'};">‚Çπ${amountDifference.toLocaleString()}</strong></p>
              </div>
              
              <!-- Detailed Analysis -->
              <details style="margin-top:12px;">
                <summary style="cursor:pointer;color:#8b5cf6;font-weight:600;padding:8px;background:rgba(139,92,246,0.1);border-radius:6px;">üìä View Detailed Analysis</summary>
                <div style="margin-top:12px;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;">
                  <pre style="white-space:pre-wrap;font-family:inherit;font-size:13px;line-height:1.6;margin:0;color:#e2e8f0;">${analysis}</pre>
                </div>
              </details>
              
              <!-- Score Breakdown -->
              ${Object.keys(detailedBreakdown).length > 0 ? `
                <details style="margin-top:12px;">
                  <summary style="cursor:pointer;color:#8b5cf6;font-weight:600;padding:8px;background:rgba(139,92,246,0.1);border-radius:6px;">üîç Score Breakdown</summary>
                  <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;">
                    ${Object.entries(detailedBreakdown).map(([key, value]) => `
                      <div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;text-align:center;">
                        <p class="muted small" style="margin:0 0 4px 0;font-size:11px;">${key.replace(/_/g, ' ')}</p>
                        <p style="margin:0;font-weight:700;font-size:14px;">${value}</p>
                      </div>
                    `).join('')}
                  </div>
                </details>
              ` : ''}
              
              <!-- Recommendation -->
              <div style="margin-top:16px;padding:12px;background:rgba(139,92,246,0.1);border-left:4px solid #8b5cf6;border-radius:4px;">
                <p style="margin:0;"><strong>üìã AI Recommendation:</strong> ${recommendation}</p>
              </div>
            </div>
            
            <!-- Uploaded Bills -->
            <div style="margin-bottom:20px;">
              <p style="margin-bottom:8px;"><strong>üìé Uploaded Bills:</strong></p>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                ${req.bills.map((bill, idx) => `
                  <a href="/uploads/${bill}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.4);border-radius:8px;color:#8b5cf6;text-decoration:none;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='rgba(139,92,246,0.3)'" onmouseout="this.style.background='rgba(139,92,246,0.2)'">
                    üìÑ Bill ${idx + 1}
                  </a>
                `).join('')}
              </div>
            </div>
            
            <!-- Status and Actions -->
            <div style="display:flex;justify-content:space-between;align-items:center;padding-top:16px;border-top:2px solid rgba(139,92,246,0.2);">
              <div>
                <p style="margin-bottom:4px;"><strong>Status:</strong> <span class="status-badge status-${req.status.replace('_', '-')}">${req.status.replace('_', ' ').toUpperCase()}</span></p>
                <p class="muted small" style="margin:0;">Submitted: ${new Date(req.timestamp).toLocaleString()}</p>
                ${req.approved_at ? `<p class="muted small" style="color:#00ff87;margin:4px 0 0 0;">‚úì Approved: ${new Date(req.approved_at).toLocaleString()}</p>` : ''}
              </div>
              <div>
                ${req.status === 'pending_admin_review' && verdict === 'GENUINE' ? `
                  <button onclick="approvePayment(${req.id})" class="fund-btn" style="background:linear-gradient(135deg, #00ff87 0%, #22c55e 100%);padding:12px 24px;font-size:15px;">
                    ‚úÖ Approve Payment
                  </button>
                ` : ''}
                ${req.status === 'pending_admin_review' && verdict === 'NEEDS_REVIEW' ? `
                  <div style="text-align:right;">
                    <p style="color:#fbbf24;font-weight:700;margin-bottom:8px;">‚ö†Ô∏è REVIEW CAREFULLY</p>
                    <button onclick="if(confirm('This request needs careful review. Are you sure you want to approve?')) approvePayment(${req.id})" class="fund-btn" style="background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);padding:10px 20px;">
                      Review & Approve
                    </button>
                  </div>
                ` : ''}
                ${req.status === 'pending_admin_review' && (verdict === 'SUSPICIOUS' || verdict === 'UNKNOWN') ? `
                  <p style="color:#ff006e;font-weight:700;font-size:14px;text-align:right;">
                    ‚ùå NOT RECOMMENDED<br>
                    <span style="font-size:12px;font-weight:400;">Requires detailed investigation</span>
                  </p>
                ` : ''}
                ${req.status === 'approved' ? `
                  <span style="color:#00ff87;font-weight:700;font-size:16px;">‚úÖ PAYMENT APPROVED</span>
                ` : ''}
              </div>
            </div>
          </div>
        `;
        }).join('');
      } catch (err) {
        console.error('‚ùå Error loading verification requests:', err);
        const container = document.getElementById('verificationRequestsList');
        container.innerHTML = `
          <div style="text-align:center;padding:40px;color:#ff006e;">
            <p><strong>‚ö†Ô∏è Error loading verification requests</strong></p>
            <p class="muted small" style="margin-top:8px;">${err.message}</p>
            <button onclick="loadVerificationRequests()" class="fund-btn" style="margin-top:16px;">üîÑ Retry</button>
          </div>
        `;
      }
    }

    async function approvePayment(requestId) {
      if (!confirm('Approve this payment request? The NGO will be notified that funds will be transferred.')) return;
      
      try {
        const res = await fetch(`/admin-approve-payment/${requestId}`, {
          method: 'POST'
        });
        const data = await res.json();
        alert(data.message || 'Payment approved!');
        loadVerificationRequests();
      } catch (err) {
        alert('Error approving payment');
      }
    }

    // Load Signed Contracts for Review
    async function loadSignedContracts() {
      const container = document.getElementById('signedContractsList');
      
      try {
        const res = await fetch('/api/admin/signed-contracts');
        const contracts = await res.json();
        
        if (!contracts || contracts.length === 0) {
          container.innerHTML = `
            <div style="text-align:center;padding:40px;background:rgba(139,92,246,0.05);border-radius:12px;">
              <div style="font-size:64px;margin-bottom:16px;">‚úÖ</div>
              <h3>No Signed Contracts Pending Review</h3>
              <p class="muted">All contracts have been processed.</p>
            </div>
          `;
          return;
        }
        // display margin colour
        container.innerHTML = contracts.map(contract => `
          <div class="request-card" style="background:rgba(10,14,39,0.7);border:2px solid rgba(139,92,246,0.4);border-radius:16px;padding:24px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
              <div>
                <h3 style="margin:0 0 8px 0;">‚úçÔ∏è Signed Contract #${contract.id}</h3>
                <p style="margin:0;"><strong>Organization:</strong> ${contract.ngo_name}</p>
                <p style="margin:4px 0 0 0;" class="muted small">Signed: ${new Date(contract.signed_date).toLocaleString()}</p>
              </div>
              <span style="background:linear-gradient(135deg, #fbbf24, #f59e0b);padding:8px 16px;border-radius:20px;font-size:12px;font-weight:700;color:#000;">
                ‚è≥ AWAITING REVIEW
              </span>
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:16px 0;">
              <div>
                <p class="muted small">Original Contract</p>
                <a href="/uploads/${contract.filename}" target="_blank" class="fund-btn" style="display:inline-block;padding:8px 16px;font-size:13px;margin-top:4px;">
                  üìÑ View Original
                </a>
              </div>
              <div>
                <p class="muted small">Signed Contract</p>
                <a href="/uploads/${contract.signed_filename}" target="_blank" class="fund-btn" style="display:inline-block;padding:8px 16px;font-size:13px;margin-top:4px;background:linear-gradient(135deg, #8b5cf6, #7c3aed);">
                  ‚úçÔ∏è View Signed
                </a>
              </div>
            </div>
            
            <div style="display:flex;gap:12px;margin-top:20px;padding-top:20px;border-top:1px solid rgba(139,92,246,0.2);">
              <button onclick="approveContract(${contract.id})" class="fund-btn" style="flex:1;background:linear-gradient(135deg, #00ff87, #22c55e);color:#000;padding:12px 24px;font-size:15px;">
                ‚úÖ Approve Contract
              </button>
              <button onclick="rejectContract(${contract.id})" class="fund-btn" style="flex:1;background:linear-gradient(135deg, #ff006e, #ef4444);padding:12px 24px;font-size:15px;">
                ‚ùå Reject Contract
              </button>
            </div>
          </div>
        `).join('');
        
      } catch (err) {
        console.error('Error loading signed contracts:', err);
        container.innerHTML = `<div class="request-card"><p style="color:#ff006e;">Error loading signed contracts.</p></div>`;
      }
    }
    
    // Approve Contract
    async function approveContract(contractId) {
      if (!confirm('Are you sure you want to APPROVE this contract? The NGO will be notified.')) {
        return;
      }
      
      try {
        const res = await fetch(`/admin-approve-contract/${contractId}`, {
          method: 'POST'
        });
        const data = await res.json();
        alert('‚úÖ ' + (data.message || 'Contract approved!'));
        loadSignedContracts();
      } catch (err) {
        alert('‚ùå Error approving contract');
      }
    }
    
    // Reject Contract
    async function rejectContract(contractId) {
      const reason = prompt('Please enter the reason for rejection:');
      if (!reason || reason.trim() === '') {
        alert('Rejection cancelled. Please provide a reason.');
        return;
      }
      
      try {
        const res = await fetch(`/admin-reject-contract/${contractId}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({reason: reason.trim()})
        });
        const data = await res.json();
        alert('‚ùå ' + (data.message || 'Contract rejected'));
        loadSignedContracts();
      } catch (err) {
        alert('‚ùå Error rejecting contract');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      loadNGOData();
      loadDeletionRequests();
      loadContracts();
      loadSignedContracts();
      loadVerificationRequests();
      // Refresh data every 10 seconds
      setInterval(() => {
        loadData();
        loadNGOData();
        if (currentTab === 'deletion-requests') loadDeletionRequests();
        if (currentTab === 'contracts') loadContracts();
        if (currentTab === 'signed-contracts') loadSignedContracts();
        if (currentTab === 'verification') loadVerificationRequests();
      }, 10000);
    });
  </script>
</body>
</html>
